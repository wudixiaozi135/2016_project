var AssetAdapter=function(){function t(){}var e=(__define,t),i=e.prototype;return i.getAsset=function(t,e,i){function r(r){e.call(i,r,t)}if(RES.hasRes(t)){var s=RES.getRes(t);s?r(s):RES.getResAsync(t,r,this)}else RES.getResByUrl(t,r,this,RES.ResourceItem.TYPE_IMAGE)},t}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var Color=function(){function t(){}var e=(__define,t);e.prototype;return t.WHITE=16777215,t.BLACK=0,t.RED=16711680,t.COLOR_009900=39168,t.COLOR_009933=39219,t.COLOR_009966=39270,t.COLOR_009999=39321,t.COLOR_0099cc=39372,t.COLOR_0099ff=39423,t.COLOR_000000=0,t}();egret.registerClass(Color,"Color");var ColorType;!function(t){t[t.white=0]="white",t[t.black=1]="black",t[t.red=2]="red",t[t.color000000=10]="color000000",t[t.color009900=11]="color009900",t[t.color009933=12]="color009933",t[t.color009966=13]="color009966",t[t.color009999=14]="color009999",t[t.color0099cc=15]="color0099cc",t[t.color0099ff=16]="color0099ff"}(ColorType||(ColorType={}));var GameEventConstant=function(){function t(){}var e=(__define,t);e.prototype;return t.GAME_OVER="game_over",t.EXIT="exit",t.RESTART_GAME="restart_game",t}();egret.registerClass(GameEventConstant,"GameEventConstant");var xd;!function(t){var e=egret.EventDispatcher,i=function(){function i(){}var r=(__define,i);r.prototype;return i.addEventListener=function(t,e,r,s,o){i.dispatcher.addEventListener(t,e,r,s,o)},i.once=function(t,e,r,s,o){i.dispatcher.once(t,e,r,s,o)},i.removeEventListener=function(t,e,r,s){i.dispatcher.removeEventListener(t,e,r,s)},i.hasEventListener=function(t){return i.hasEventListener(t)},i.dispatchEvent=function(e,r){return void 0===r&&(r=null),i.dispatcher.dispatchEvent(new t.GameEvent(e,r))},i.willTrigger=function(t){return i.dispatcher.willTrigger(t)},i.dispatcher=new e,i}();t.GameDispatcher=i,egret.registerClass(i,"xd.GameDispatcher")}(xd||(xd={}));var xd;!function(t){var e=function(t){function e(e,i,r,s){void 0===i&&(i=null),void 0===r&&(r=!1),void 0===s&&(s=!1),t.call(this,e,r,s),i&&(this._obj=i)}__extends(e,t);var i=__define,r=e,s=r.prototype;return s.clone=function(t){return new e(this.type,t?t:this._obj,this.bubbles,this.cancelable)},s.toString=function(){console.log("GameEvent: ","type","bubbles","cancelable")},i(s,"param",function(){return this._obj}),e}(egret.Event);t.GameEvent=e,egret.registerClass(e,"xd.GameEvent")}(xd||(xd={}));var SimpleData=function(){function t(){}var e=(__define,t),i=e.prototype;return i.setData=function(t,e){this.row=t,this.column=e},t}();egret.registerClass(SimpleData,"SimpleData");var Diamond=function(t){function e(e,i){t.call(this),this.blockW=e,this.blockH=i,this._data=new SimpleData}__extends(e,t);var i=__define,r=e,s=r.prototype;return s.createChildren=function(){t.prototype.createChildren.call(this),this.block=new eui.Rect,this.block.width=this.blockW,this.block.height=this.blockH,this.block.fillAlpha=.9,this.block.strokeColor=16777215,this.color?this.block.fillColor=this.color:this.block.fillColor=Color.BLACK,this.addChild(this.block),this.block.touchEnabled=!1,this.block.touchChildren=!1},s.changeColor=function(t){switch(t){case ColorType.black:this.color=Color.BLACK;break;case ColorType.white:this.color=Color.WHITE;break;case ColorType.red:this.color=Color.RED;break;case ColorType.color009900:this.color=Color.COLOR_009900;break;case ColorType.color009933:this.color=Color.COLOR_009933;break;case ColorType.color009966:this.color=Color.COLOR_009966;break;case ColorType.color009999:this.color=Color.COLOR_009999;break;case ColorType.color0099cc:this.color=Color.COLOR_0099cc;break;case ColorType.color0099ff:this.color=Color.COLOR_0099ff;break;case ColorType.color000000:this.color=Color.COLOR_000000}this.block&&(this.block.fillColor=this.color)},s.reset=function(){this.block&&(this.block.fillColor=Color.BLACK)},s.hide=function(){return this.touchEnabled=!1,this.visible=!1,this.visible},s.show=function(){return this.touchEnabled=!0,this.visible=!0,this.visible},i(s,"data",function(){return this._data}),e}(eui.Group);egret.registerClass(Diamond,"Diamond",["IDiamond"]);var GameOver=function(t){function e(){t.call(this),this.touchThrough=!1}__extends(e,t);var i=(__define,e),r=i.prototype;return r.createChildren=function(){t.prototype.createChildren.call(this),this.percentWidth=this.percentHeight=100;var e=new eui.Rect;e.percentWidth=100,e.percentHeight=100,e.fillAlpha=.8,e.fillColor=0,this.addChild(e),this.endLabel=new eui.Label("Game Over!"),this.endLabel.size=50,this.addChild(this.endLabel),this.endLabel.touchEnabled=!1,this.endLabel.horizontalCenter=0,this.endLabel.verticalCenter=0,this.buttonContainer=new eui.Group;var i=new eui.HorizontalLayout;i.gap=30,this.buttonContainer.layout=i,this.addChild(this.buttonContainer),this.restart=new eui.Button,this.restart.addEventListener(eui.UIEvent.CREATION_COMPLETE,function(){this.restart.labelDisplay.size=45,this.restart.removeEventListener(eui.UIEvent.CREATION_COMPLETE,arguments.callee)},this),this.restart.width=150,this.restart.height=80,this.restart.label="重玩",this.buttonContainer.addChild(this.restart),this.exit=new eui.Button,this.exit.addEventListener(eui.UIEvent.CREATION_COMPLETE,function(){this.exit.labelDisplay.size=45,this.exit.removeEventListener(eui.UIEvent.CREATION_COMPLETE,arguments.callee)},this),this.exit.width=150,this.exit.height=80,this.exit.label="退出",this.buttonContainer.addChild(this.exit),this.buttonContainer.bottom=100,this.buttonContainer.horizontalCenter=0,this.buttonContainer.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClickHandler,this)},r.onClickHandler=function(t){var e=t.target;e==this.exit?xd.GameDispatcher.dispatchEvent(GameEventConstant.EXIT):e==this.restart&&xd.GameDispatcher.dispatchEvent(GameEventConstant.RESTART_GAME)},e}(eui.Group);egret.registerClass(GameOver,"GameOver");var GameScene=function(t){function e(){t.call(this),this.rowAndColumn=4,this._score=0,this.radix=5,this.width=egret.MainContext.instance.stage.stageWidth,this.height=egret.MainContext.instance.stage.stageHeight,this.gridW=this.width/this.rowAndColumn,this.gridH=this.height/this.rowAndColumn,this.moveGrids=[]}__extends(e,t);var i=__define,r=e,s=r.prototype;return s.drawGrids=function(t,e){this.map=this.map||[[],[],[],[],[]];for(var i=0;t>i;i++)for(var r=0;e>r;r++)this.map[i][r]=0,this.gridLayer.graphics.drawRect(i*this.gridW,r*this.gridH,this.gridW,this.gridH);this.gridLayer.graphics.endFill()},s.createChildren=function(){t.prototype.createChildren.call(this),this.startTxt=new eui.Label,this.startTxt.text="开始",this.startTxt.textColor=16777215,this.startTxt.size=45,this.startTxt.bold=!0,this.startTxt.touchEnabled=!1,this.gridLayer=new egret.Shape,this.addChild(this.gridLayer),this.gridLayer.graphics.clear(),this.gridLayer.graphics.lineStyle(1,0,1),this.gridLayer.graphics.beginFill(16777215,.8),this.drawGrids(this.rowAndColumn,this.rowAndColumn),this.startGame(),this.titleLabel=new eui.Label,this.addChild(this.titleLabel),this.titleLabel.textColor=16711680,this.titleLabel.bold=!0,this.titleLabel.horizontalCenter=0,this.titleLabel.touchEnabled=!1,this.titleLabel.top=0,this.score=0,this.addEvent(),xd.GameDispatcher.addEventListener(GameEventConstant.RESTART_GAME,this.handlerRestart,this),xd.GameDispatcher.addEventListener(GameEventConstant.EXIT,this.onExitGame,this)},s.onExitGame=function(t){egret.ExternalInterface.call("exitGame","true")},s.handlerRestart=function(t){this.gameOver&&this.contains(this.gameOver)&&this.removeChild(this.gameOver),this.redGrid&&this.contains(this.redGrid)&&this.removeChild(this.redGrid),this.score=0,this.initGridsPosition(),egret.callLater(function(){this.addEvent()},this,50)},s.addEvent=function(){this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onClickHandler,this)},s.removeEvent=function(){this.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onClickHandler,this)},s.onClickHandler=function(t){var e=Math.floor(t.stageY/this.gridH),i=Math.floor(t.stageX/this.gridW),r=new SimpleData;r.setData(e,i);var s=t.target;if(s instanceof Diamond){if(s.data.row==this.rowAndColumn-2)s.hide(),this.score+=this.radix;else if(this.gameOverHandler(r))return}else if(this.gameOverHandler(r))return;this.stepNext()},s.gameOverHandler=function(t){var e,i;return t&&(e=t.row,i=t.column),this.map[e][i]?!0:(this.removeEvent(),this.redGrid=this.redGrid=new Diamond(this.gridW,this.gridH),this.redGrid.changeColor(ColorType.red),this.contains(this.redGrid)||(this.addChild(this.redGrid),this.redGrid.x=i*this.gridW,this.redGrid.y=e*this.gridH),this.gameOver=this.gameOver||new GameOver,this.contains(this.gameOver)||this.addChild(this.gameOver),console.info("game over!!!"),!0)},s.startGame=function(){this.grids=new Array;for(var t=0;t<this.rowAndColumn-1;t++){var e=new Diamond(this.gridW,this.gridH);e.data.setData(0,0),this.grids[t]=e,this.addChild(e)}this.initGridsPosition()},s.initGridsPosition=function(){for(var t,e=0,i=0,r=this.rowAndColumn-1;r>i;i++)this.grids&&this.grids.length>0&&(t=this.grids[i],e=Math.floor(4*Math.random()),t.x=e*this.gridW,t.y=i*this.gridH,t.data.setData(i,e),this.map[i][e]=1,this.moveGrids[i]=t,i==r-1&&(this.contains(this.startTxt)||(this.addChild(this.startTxt),this.startTxt.x=t.x+.5*(t.width-this.startTxt.width),this.startTxt.y=t.y+.5*(t.height-this.startTxt.height))))},s.stepNext=function(){var t,e,i=this.rowAndColumn-1;this.contains(this.startTxt)&&this.removeChild(this.startTxt);for(var r=0;i>r;r++)t=this.moveGrids[r],t.data.row++,t.y+=this.gridH,t.data.row==i&&(e=Math.floor(Math.random()*i),t.x=e*this.gridW,t.y=0,t.data.row=0,t.data.column=e,t.show());this.updateMapData()},s.updateMapData=function(){var t,e,i=this.rowAndColumn;for(t=0;i>t;t++)for(e=0;5>e;e++)this.map[t][e]=0;var r,s,o;for(t=0;t<this.moveGrids.length;t++)r=this.moveGrids[t],s=r.data.row,o=r.data.column,this.map[s][o]=1},i(s,"score",function(){return this._score},function(t){if(this._score=t,this.titleLabel&&(this.titleLabel.text="Score: "+t),this._score>0){if(this._score%1e3==0)for(var e,i=0;i<this.moveGrids.length;i++)e=ColorType.color000000+Math.floor(this._score/1e3)%(ColorType.color0099ff-ColorType.color009900+2),this.moveGrids[i].changeColor(e)}else 0==this._score&&this.moveGrids&&this.moveGrids.forEach(function(t,e,i){t.reset()},this)}),e}(eui.Group);egret.registerClass(GameScene,"GameScene");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),r=i.prototype;return r.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},r.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.apply(this,arguments),this.isThemeLoadEnd=!1,this.isResourceLoadEnd=!1}__extends(e,t);var i=(__define,e),r=i.prototype;return r.createChildren=function(){t.prototype.createChildren.call(this);var e=new AssetAdapter;this.stage.frameRate=60,this.stage.registerImplementation("eui.IAssetAdapter",e),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},r.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var e=new eui.Theme("resource/default.thm.json",this.stage);e.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},r.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},r.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},r.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.startCreateScene()},r.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},r.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},r.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},r.startCreateScene=function(){var t=new GameScene;this.addChild(t)},e}(eui.UILayer);egret.registerClass(Main,"Main");var ThemeAdapter=function(){function t(){}var e=(__define,t),i=e.prototype;return i.getTheme=function(t,e,i,r){function s(t){e.call(r,t)}function o(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),i.call(r))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(t,s,this,RES.ResourceItem.TYPE_TEXT)},t}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);
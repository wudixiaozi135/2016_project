var AssetAdapter=function(){function e(){}var t=(__define,e),i=t.prototype;return i.getAsset=function(e,t,i){function n(n){t.call(i,n,e)}if(RES.hasRes(e)){var r=RES.getRes(e);r?n(r):RES.getResAsync(e,n,this)}else RES.getResByUrl(e,n,this,RES.ResourceItem.TYPE_IMAGE)},e}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var ClientProtocol;!function(e){e[e.CM_HAND_SHAKE_SUCCESS=1]="CM_HAND_SHAKE_SUCCESS",e[e.CM_PROTOCOL_LOGIN=2]="CM_PROTOCOL_LOGIN",e[e.CM_START_GAME=3]="CM_START_GAME",e[e.CM_GAIN_REWARD=4]="CM_GAIN_REWARD"}(ClientProtocol||(ClientProtocol={}));var FruitItemType;!function(e){e[e.typeApple=1]="typeApple",e[e.typeBar=2]="typeBar",e[e.typeOrange=3]="typeOrange",e[e.typePear=4]="typePear",e[e.typeRing=5]="typeRing",e[e.typeSeven=6]="typeSeven",e[e.typeStar=7]="typeStar",e[e.typeWatermelon=8]="typeWatermelon",e[e.typeGoodLuck=9]="typeGoodLuck"}(FruitItemType||(FruitItemType={}));var GameState;!function(e){e[e.gameStart=100]="gameStart",e[e.gameProcess=200]="gameProcess",e[e.gameEnd=300]="gameEnd"}(GameState||(GameState={}));var MapUtils=function(){function e(){}var t=(__define,e);t.prototype;return e.getPrice=function(e){var t=0;switch(e){case FruitItemType.typeApple:t=5;break;case FruitItemType.typeBar:t=25;break;case FruitItemType.typeOrange:t=5;break;case FruitItemType.typePear:t=5;break;case FruitItemType.typeRing:t=10;break;case FruitItemType.typeSeven:t=77;break;case FruitItemType.typeStar:t=15;break;case FruitItemType.typeWatermelon:t=20;break;case FruitItemType.typeGoodLuck:t=0}return t},e}();egret.registerClass(MapUtils,"MapUtils");var ProcType=function(){function e(){}var t=(__define,e);t.prototype;return e.TYPE_SHOW=1,e.TYPE_CONTROL=2,e.TYPE_ALL=3,e}();egret.registerClass(ProcType,"ProcType");var ServerProtocol;!function(e){e[e.SM_HAND_SHAKE_SUCCESS=9999]="SM_HAND_SHAKE_SUCCESS",e[e.SM_PROTOCOL_LOGIN=1e4]="SM_PROTOCOL_LOGIN",e[e.SM_PROTOCOL_EXIT=10001]="SM_PROTOCOL_EXIT",e[e.SM_START_GAME=10002]="SM_START_GAME",e[e.SM_SHOW_REWARD=10003]="SM_SHOW_REWARD",e[e.SM_GAIN_REWARD=10004]="SM_GAIN_REWARD"}(ServerProtocol||(ServerProtocol={}));var UserData=function(){function e(){}var t=(__define,e);t.prototype;return e.ADMIN="Admin",e.userCoin=100,e}();egret.registerClass(UserData,"UserData");var FruitMachineClientEventName=function(){function e(){}var t=(__define,e);t.prototype;return e.GAME_STATE="game_state",e}();egret.registerClass(FruitMachineClientEventName,"FruitMachineClientEventName");var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var i=(__define,t),n=i.prototype;return n.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.textAlign="left"},n.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function t(){e.apply(this,arguments),this.isThemeLoadEnd=!1,this.isResourceLoadEnd=!1}__extends(t,e);var i=(__define,t),n=i.prototype;return n.createChildren=function(){e.prototype.createChildren.call(this);var t=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",t),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),this.loadingView.x=this.stage.stageWidth-this.loadingView.width>>1,this.loadingView.y=this.stage.stageHeight-this.loadingView.height>>1,RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},n.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var t=new eui.Theme("resource/default.thm.json",this.stage);t.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},n.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},n.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},n.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.startCreateScene()},n.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},n.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},n.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},n.startCreateScene=function(){var e=new egret.Bitmap;e.texture=RES.getRes("loginBg"),e.width=this.width,e.height=this.height,this.addChild(e),this.addChild(new GameScenePanel),AlertPanel.init(this.stage)},t}(eui.UILayer);egret.registerClass(Main,"Main");var ClientSocket=function(e){function t(){e.call(this),this.webSocket=new egret.WebSocket}__extends(t,e);var i=(__define,t),n=i.prototype;return t.getInstance=function(){return null==t.instance&&(t.instance=new t),t.instance},n.init=function(e,t){this.webSocket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),this.webSocket.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this.webSocket.connectByUrl(e+":"+t),this.webSocket.addEventListener(egret.Event.CLOSE,this.onSocketClose,this),this.webSocket.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onSocketError,this)},n.onSocketOpen=function(){var e={};e.proc=ClientProtocol.CM_HAND_SHAKE_SUCCESS,e.type=ProcType.TYPE_CONTROL,this.sendMesssage(e),console.log("连接成功，发送数据："+e)},n.sendMesssage=function(e){var t=JSON.stringify(e);null!=t&&(this.webSocket.writeUTF(t),this.webSocket.flush())},n.onReceiveMessage=function(e){var t=this.webSocket.readUTF(),i=JSON.parse(t);i&&this.notifiy(i)},n.onSocketClose=function(){console.log("WebSocketClose")},n.onSocketError=function(){console.log("WebSocketError")},t.instance=new t,t}(xd.Stock);egret.registerClass(ClientSocket,"ClientSocket");var ThemeAdapter=function(){function e(){}var t=(__define,e),i=t.prototype;return i.getTheme=function(e,t,i,n){function r(e){t.call(n,e)}function s(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),i.call(n))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),RES.getResByUrl(e,r,this,RES.ResourceItem.TYPE_TEXT)},e}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);var AlertPanel=function(){function e(){}var t=(__define,e);t.prototype;return e.init=function(t){e.stage=t},e.show=function(t){var i=new egret.Sprite;i.graphics.clear(),i.graphics.beginFill(0,.5),i.graphics.drawRect(0,0,e.stage.stageWidth,55);var n=new egret.TextField;n.bold=!0,n.width=e.stage.stageWidth,n.textAlign="center",n.textColor=16711680,n.text=t,i.addChild(n),n.y=.5*(i.height-n.height),e.stage.addChild(i),i.y=.5*e.stage.stageHeight,TweenMax.to(i,.7,{y:.5*(e.stage.stageHeight-i.height)-100,ease:Back.easeOut,onComplete:e.onCompleteHandler,onCompleteParams:[i]})},e.onCompleteHandler=function(){for(var t=[],i=0;i<arguments.length;i++)t[i-0]=arguments[i];t.length>0&&e.stage.removeChild(t.pop())},e}();egret.registerClass(AlertPanel,"AlertPanel");var FruitItem=function(e){function t(t){e.call(this),this.price=0,this._itemCount=0,this._enabled=!0,this.fruitType=t;var i=MapUtils.getPrice(this.fruitType);this.price=i}__extends(t,e);var i=__define,n=t,r=n.prototype;return r.createChildren=function(){e.prototype.createChildren.call(this);var t=new eui.HorizontalLayout;t.verticalAlign=egret.VerticalAlign.BOTTOM,t.gap=10,this.layout=t;var i=new eui.Group;i.touchEnabled=!1;var n,r=this.getResName(this.fruitType);r&&(n=this.getBmp(r)),i.addChild(n),i.width=n.width,i.height=n.height,this.addChild(i),this.countLabel=new eui.Label,this.addChild(this.countLabel),this.countLabel.width=150,this.itemCount=0,this.countLabel.touchEnabled=!1,this.btnAdd=new eui.Button,this.btnAdd.label="增加",this.btnMinus=new eui.Button,this.btnMinus.label="减少";var s=xd.CommonUtils.getGroup(1,null,30,[this.btnAdd,this.btnMinus]);this.addChild(s),s.touchEnabled=!1,this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),this.enabled=!0},i(r,"itemCount",function(){return this._itemCount},function(e){this._itemCount=e,this.countLabel.text="+ "+this._itemCount+"x￥"+this.price}),i(r,"enabled",function(){return this._enabled},function(e){this._enabled=e,this.btnAdd.enabled=e,this.btnMinus.enabled=e}),r.onClick=function(e){var t=e.target;t==this.btnAdd?this.addHandler&&this.addHandler(this.fruitType,this.price):t==this.btnMinus&&this.minusHandler&&this.minusHandler(this.fruitType,this.price)},r.getResName=function(e){switch(e){case FruitItemType.typeApple:return"apple";case FruitItemType.typeBar:return"bar";case FruitItemType.typeOrange:return"orange";case FruitItemType.typePear:return"pear";case FruitItemType.typeRing:return"ring";case FruitItemType.typeSeven:return"seven";case FruitItemType.typeStar:return"star";case FruitItemType.typeWatermelon:return"watermelon"}return null},r.getBmp=function(e){var t=new egret.Bitmap;return t.texture=RES.getRes(e),t},t}(eui.Group);egret.registerClass(FruitItem,"FruitItem");var GameProcessPanel=function(e){function t(){e.call(this),ClientSocket.getInstance().attach(this)}__extends(t,e);var i=(__define,t),n=i.prototype;return n.update=function(e){e.type==ProcType.TYPE_SHOW&&e.proc==ServerProtocol.SM_SHOW_REWARD&&(this.updateLog(e),this.lockBtns(!0),this.btnLock.enabled=!0,UserData.userName==UserData.ADMIN&&this.btnStart&&(this.btnStart.enabled=!0))},n.updateLog=function(e){var t=0,i=0,n=0;this.fruitItems&&this.fruitItems.length>0&&this.fruitItems.forEach(function(r){r.itemCount>0&&(e.fruitType==r.fruitType&&(t++,n=e.price*r.itemCount,this.addLog(n.toString()),this.sendShowGain(n)),i+=r.itemCount*r.price),r.itemCount=0}.bind(this)),0>=t&&i>0&&this.logView.addLog("扣除￥"+i)},n.addLog=function(e){this.logView.addLog("您获得收益￥"+e)},n.sendShowGain=function(e){var t={};t.type=ProcType.TYPE_CONTROL,t.proc=ClientProtocol.CM_GAIN_REWARD,t.userName=UserData.userName,t.gainCoin=e,ClientSocket.getInstance().sendMesssage(t)},n.createChildren=function(){e.prototype.createChildren.call(this),this.percentWidth=100,this.percentHeight=100;var t=new eui.VerticalLayout;t.gap=20,t.paddingTop=10,t.paddingLeft=10,this.layout=t;var i=new eui.Label;i.bold=!0,i.text="我的金币：",i.touchEnabled=!1,this.coinInput=new eui.Label,this.coinInput.touchEnabled=!1,this.updateCoin();var n=xd.CommonUtils.getGroup(1,null,10,[i,this.coinInput]);this.addChild(n),this.appleItem=new FruitItem(FruitItemType.typeApple),this.appleItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.appleItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.appleItem.minusHandler=function(e,t){var i=UserData.userCoin;this.appleItem.itemCount>0&&(this.appleItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.barItem=new FruitItem(FruitItemType.typeBar),this.barItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.barItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.barItem.minusHandler=function(e,t){var i=UserData.userCoin;this.barItem.itemCount>0&&(this.barItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.orangeItem=new FruitItem(FruitItemType.typeOrange),this.orangeItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.orangeItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.orangeItem.minusHandler=function(e,t){var i=UserData.userCoin;this.orangeItem.itemCount>0&&(this.orangeItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.pearItem=new FruitItem(FruitItemType.typePear),this.pearItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.pearItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.pearItem.minusHandler=function(e,t){var i=UserData.userCoin;this.pearItem.itemCount>0&&(this.pearItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.ringItem=new FruitItem(FruitItemType.typeRing),this.ringItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.ringItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.ringItem.minusHandler=function(e,t){var i=UserData.userCoin;this.ringItem.itemCount>0&&(this.ringItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.sevenItem=new FruitItem(FruitItemType.typeSeven),this.sevenItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.sevenItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.sevenItem.minusHandler=function(e,t){var i=UserData.userCoin;this.sevenItem.itemCount>0&&(this.sevenItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.starItem=new FruitItem(FruitItemType.typeStar),this.starItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.starItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.starItem.minusHandler=function(e,t){var i=UserData.userCoin;this.starItem.itemCount>0&&(this.starItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.watermelonItem=new FruitItem(FruitItemType.typeWatermelon),this.watermelonItem.addHandler=function(e,t){var i=UserData.userCoin;i>=t?(this.watermelonItem.itemCount++,i-=t,UserData.userCoin=i,this.updateCoin()):AlertPanel.show("金币不足")}.bind(this),this.watermelonItem.minusHandler=function(e,t){var i=UserData.userCoin;this.watermelonItem.itemCount>0&&(this.watermelonItem.itemCount--,i+=t,UserData.userCoin=i,this.updateCoin())}.bind(this),this.fruitItems=[this.appleItem,this.barItem,this.orangeItem,this.pearItem,this.ringItem,this.sevenItem,this.starItem,this.watermelonItem],this.fruitItems.sort(function(e,t){return e.price<t.price?-1:e.price>t.price?1:0});var r=xd.CommonUtils.getGroup(2,null,10,this.fruitItems);this.addChild(r),this.logView=new xd.LogView(this.stage.stageWidth-20,280);var s=xd.CommonUtils.getGroup(1,null,0,[this.logView]);this.addChild(s),this.logView.addLog("欢迎"+UserData.userName+"进入"),this.btnStart=new eui.Button,this.btnStart.label="抽奖",this.btnStart.width=100,this.btnLock=new eui.Button,this.btnLock.width=100,this.btnLock.label="交易锁定";var a;a=UserData.userName!=UserData.ADMIN?[this.btnLock]:[this.btnStart,this.btnLock];var o=xd.CommonUtils.getGroup(1,null,15,a);this.addChild(o),o.includeInLayout=!1,o.x=this.stage.stageWidth-o.width-10,o.y=10,o.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),o.touchEnabled=!1},n.updateCoin=function(){this.coinInput.text="￥"+UserData.userCoin},n.onClick=function(e){var t=e.target;if(t==this.btnStart){var i={};i.type=ProcType.TYPE_CONTROL,i.proc=ClientProtocol.CM_START_GAME,i.userName=UserData.userName,ClientSocket.getInstance().sendMesssage(i),UserData.userName==UserData.ADMIN&&(this.btnStart.enabled=!1)}else t==this.btnLock&&(this.checkIsBought()?(this.lockBtns(!1),this.btnLock.enabled=!1,AlertPanel.show("交易已锁定")):AlertPanel.show("购买后才能锁定"))},n.getLockItems=function(){var e=[];return this.fruitItems&&this.fruitItems.length>0&&this.fruitItems.forEach(function(t){t.itemCount>0&&e.push({fruitType:t.fruitType,itemCount:t.itemCount})}),e},n.checkIsBought=function(){var e=!1;return this.fruitItems&&this.fruitItems.length>0&&(e=this.fruitItems.some(function(e){return e.itemCount>0})),e},n.lockBtns=function(e){this.fruitItems&&this.fruitItems.length>0&&this.fruitItems.forEach(function(t){t.enabled=e})},t}(eui.Group);egret.registerClass(GameProcessPanel,"GameProcessPanel",["xd.IObserver"]);var GameScenePanel=function(e){function t(){e.call(this);var t=egret.MainContext.instance.stage;this.width=t.stageWidth,this.height=t.stageHeight,ClientSocket.getInstance().attach(this),this.init()}__extends(t,e);var i=(__define,t),n=i.prototype;return n.init=function(){var e=getConfigData();ClientSocket.getInstance().init("ws://"+e.host,e.port),xd.GameDispatcher.addEventListener(FruitMachineClientEventName.GAME_STATE,this.onGameState,this),xd.GameDispatcher.dispatchEvent(FruitMachineClientEventName.GAME_STATE,{type:GameState.gameStart})},n.onGameState=function(e){this.removeChildren();var t=e.param.type;switch(t){case GameState.gameStart:var i=new LoginPanel;this.addChild(i);break;case GameState.gameProcess:var n=new GameProcessPanel;this.addChild(n);break;case GameState.gameEnd:}},n.update=function(e){e.type==ProcType.TYPE_CONTROL&&e.proc==ClientProtocol.CM_PROTOCOL_LOGIN&&xd.GameDispatcher.dispatchEvent(FruitMachineClientEventName.GAME_STATE,{type:GameState.gameProcess})},t}(eui.Group);egret.registerClass(GameScenePanel,"GameScenePanel",["xd.IObserver"]);var LoginPanel=function(e){function t(){e.call(this)}__extends(t,e);var i=(__define,t),n=i.prototype;return n.createChildren=function(){e.prototype.createChildren.call(this),this.touchEnabled=!1,this._container=new eui.Group,this._container.touchEnabled=!1;var t=new eui.VerticalLayout;t.horizontalAlign=egret.HorizontalAlign.CENTER,this._container.layout=t,this.addChild(this._container);var i=new eui.Label("名称：");this._inputName=new eui.TextInput;var n=xd.CommonUtils.getGroup(1,egret.VerticalAlign.MIDDLE,10,[i,this._inputName]);this._container.addChild(n),n.touchEnabled=!1,this._btnCancel=new eui.Button,this._btnCancel.label="取消",this._btnLogin=new eui.Button,this._btnLogin.label="登陆";var r=new eui.Group,s=new eui.HorizontalLayout;s.gap=20,s.paddingLeft=100,r.layout=s,r.addChild(this._btnCancel),r.addChild(this._btnLogin),this._container.addChild(r),r.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),this.verticalCenter=0,this.horizontalCenter=0},n.onClick=function(e){var t=e.target;if(t==this._btnCancel)egret.ExternalInterface.call("GameExit","true");else if(t==this._btnLogin){var i=this._inputName.text.trim();if(""==i)return AlertPanel.show("用户名为空！！！"),void this._inputName.textDisplay.setFocus();var n=i.toLowerCase();if("root"==n||"admin"==n)return AlertPanel.show("非法用户名！！！"),this._inputName.text="",void this._inputName.textDisplay.setFocus();"18255191766"==i&&(i=UserData.ADMIN);var r={};r.proc=ClientProtocol.CM_PROTOCOL_LOGIN,r.type=ProcType.TYPE_CONTROL,r.userName=i,UserData.userName=i,ClientSocket.getInstance().sendMesssage(r)}},t}(eui.Group);egret.registerClass(LoginPanel,"LoginPanel");